{% extends 'base.html' %}

{% block title %}Crear Orden - CRM PACS{% endblock %}

{% block extra_css %}
<style>
    .page-header { margin-bottom: 2rem; }
    .page-title { font-size: 2rem; font-weight: 700; color: var(--color-primario); }

    .order-form { background: var(--color-fondo-card); border: 1px solid var(--color-borde); border-radius: 12px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
    
    .form-section { margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 1px dashed var(--color-borde); }
    .form-section:last-of-type { border-bottom: none; margin-bottom: 0; }
    .form-section h2 { font-size: 1.25rem; font-weight: 600; color: var(--color-primario); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
    
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem 2rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
    
    label { font-size: 0.9rem; font-weight: 600; color: var(--color-texto-secundario); }
    input, select, textarea { width: 100%; padding: 0.85rem 1rem; border-radius: 8px; border: 1px solid var(--color-borde); background: var(--color-input-bg); font-size: 0.95rem; font-family: 'Inter', sans-serif; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primario); }
    
    .input-group { display: flex; gap: 0.5rem; }
    
    /* Resultados de búsqueda */
    #search-results { margin-top: 0.5rem; border: 1px solid var(--color-borde); border-radius: 8px; max-height: 200px; overflow-y: auto; display: none; }
    .result-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--color-borde); background: white; }
    .result-item:hover { background-color: var(--color-fondo); }
    .result-item:last-child { border-bottom: none; }
    
    /* Tarjeta de cliente seleccionado */
    #selected-client-card { background-color: #e3f2fd; padding: 1rem; border-radius: 8px; border: 1px solid #90caf9; display: none; margin-top: 1rem; }
    #selected-client-card.active { display: block; }
    
    .form-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }

    /* Estilos para enlace deshabilitado (Mejora 11) */
    .link-disabled { color: #999 !important; cursor: not-allowed; text-decoration: none; pointer-events: none; opacity: 0.6; }

    /* ESTILO NUEVO: Grupo de Password */
    .password-wrapper { position: relative; }
    .password-wrapper input { padding-right: 40px; } /* Espacio para el icono */
    .toggle-password {
        position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
        background: none; border: none; cursor: pointer; color: #999;
    }
    .toggle-password:hover { color: var(--color-primario); }
</style>
{% endblock %}

{% block content %}

    <div class="page-header">
        <h1 class="page-title">Crear Nueva Orden de Servicio</h1>
    </div>

    <form method="POST" class="order-form" id="create-order-form">
        {% csrf_token %}
        
        <!-- Campos ocultos para IDs -->
        <input type="hidden" name="cliente_id" id="id_cliente_hidden" value="{{ cliente_pre.id|default:'' }}">

        <!-- SECCIÓN 1: CLIENTE -->
        <section class="form-section">
            <h2>
                <svg style="width:24px;height:24px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                Información del Cliente
            </h2>
            
            <div class="form-group">
                <label for="search-input">Buscar Cliente (Nombre o Teléfono)</label>
                <div class="input-group">
                    <input type="text" id="search-input" placeholder="Escribe para buscar..." autocomplete="off" {% if cliente_pre %}disabled value="{{ cliente_pre.nombre_completo }}"{% endif %}>
                    <button type="button" id="btn-buscar" class="btn btn-primary">Buscar</button>
                </div>
                <!-- Lista desplegable de resultados -->
                <div id="search-results"></div>
                
                <small style="margin-top: 0.5rem; display: block; color: #777;">
                    ¿Cliente nuevo? <a href="{% url 'crear_cliente' %}" target="_blank" style="color: var(--color-primario); font-weight: bold;">Regístralo aquí</a> y luego búscalo.
                </small>
            </div>

            <!-- Tarjeta visual del cliente seleccionado -->
            <div id="selected-client-card" class="{% if cliente_pre %}active{% endif %}">
                <strong>Cliente Seleccionado:</strong> <span id="display-nombre">{{ cliente_pre.nombre_completo }}</span><br>
                <small>Tel: <span id="display-telefono">{{ cliente_pre.telefono }}</span></small>
                <button type="button" id="btn-cambiar-cliente" style="float: right; background: none; border: none; color: #d32f2f; cursor: pointer; text-decoration: underline; font-size: 0.85rem;">Cambiar</button>
            </div>
        </section>

        <!-- SECCIÓN 2: EQUIPO -->
        <section class="form-section">
            <h2>
                <svg style="width:24px;height:24px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                Información del Equipo
            </h2>
            <div class="form-grid">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="equipo_select">Seleccionar Equipo Registrado *</label>
                    <select name="equipo_id" id="equipo_select" required>
                        <!-- La lógica de backend ya llena esto si hay equipos_pre, pero el texto inicial se maneja en JS o aquí -->
                        {% if equipos_pre %}
                            <option value="">-- Seleccionar Equipo --</option>
                            {% for equipo in equipos_pre %}
                                <option value="{{ equipo.id }}">{{ equipo.tipo_equipo }} {{ equipo.marca }} {{ equipo.modelo }} (S/N: {{ equipo.numero_serie }})</option>
                            {% endfor %}
                        {% else %}
                            <option value="">-- Primero selecciona un cliente --</option>
                        {% endif %}
                    </select>
                    
                    <!-- MEJORA 11: Enlace deshabilitado por defecto -->
                    <div style="margin-top: 0.5rem;">
                        <span style="font-size: 0.9rem; color: #555;">¿Equipo nuevo? </span>
                        <a href="#" id="link-crear-equipo" class="link-disabled" target="_blank" style="color:var(--color-primario); font-weight: 500;">
                            Registrar nuevo equipo (Abre en otra pestaña)
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN 3: DETALLES DEL SERVICIO -->
        <section class="form-section">
            <h2>
                <svg style="width:24px;height:24px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Detalles del Servicio
            </h2>
            <div class="form-group">
                <label for="descripcion_falla">Descripción de la Falla *</label>
                <textarea name="descripcion_falla" id="descripcion_falla" rows="4" placeholder="Describe el problema reportado por el cliente..." required></textarea>
            </div>
            <div class="form-grid">
                
                <!-- MEJORA: CAMPO DE CONTRASEÑA SEGURO -->
                <div class="form-group">
                    <label for="contrasena">Contraseña del Equipo (Opcional)</label>
                    <div class="password-wrapper">
                        <input type="password" name="contrasena_equipo" id="contrasena" placeholder="PIN, Patrón o Contraseña" autocomplete="new-password">
                        <button type="button" class="toggle-password" onclick="togglePasswordVisibility('contrasena')" title="Mostrar/Ocultar">
                            <svg style="width:20px;height:20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="prioridad">Prioridad</label>
                    <select name="prioridad" id="prioridad">
                        {% for codigo, nombre in prioridades %}
                            <option value="{{ codigo }}" {% if codigo == 'Normal' %}selected{% endif %}>{{ nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="tecnico">Asignar Técnico</label>
                    <select name="tecnico_asignado" id="tecnico">
                        <option value="">-- Sin asignar --</option>
                        {% for tecnico in tecnicos_list %}
                            <option value="{{ tecnico.id }}">{{ tecnico.first_name }} {{ tecnico.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </section>

        <div class="form-actions">
            <a href="{% url 'lista_ordenes' %}" class="btn btn-secondary" style="text-decoration: none; background:#fff; border:1px solid #ccc; color:#333;">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar Orden</button>
        </div>
    </form>

{% endblock %}

{% block extra_js %}
<script>
    // MEJORA: Función global para mostrar/ocultar contraseñas
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const btnBuscar = document.getElementById('btn-buscar');
        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('search-results');
        const clientHiddenInput = document.getElementById('id_cliente_hidden');
        const equipoSelect = document.getElementById('equipo_select');
        const card = document.getElementById('selected-client-card');
        const displayNombre = document.getElementById('display-nombre');
        const displayTel = document.getElementById('display-telefono');
        const btnCambiar = document.getElementById('btn-cambiar-cliente');
        const linkCrearEquipo = document.getElementById('link-crear-equipo');

        // --- 1. LÓGICA DE INICIALIZACIÓN (CORRECCIÓN IMPORTANTE) ---
        // Verificamos si ya hay un cliente pre-cargado desde el servidor
        const clientePreId = clientHiddenInput.value;
        if (clientePreId) {
            // Si hay cliente, habilitamos el enlace de crear equipo inmediatamente
            activarEnlaceEquipo(clientePreId);
        } else {
            // Si no, aseguramos que el enlace esté bloqueado
            desactivarEnlaceEquipo();
        }

        // --- 2. MANEJO DEL ENLACE "CREAR EQUIPO" (MEJORA 11) ---
        function activarEnlaceEquipo(clienteId) {
            if (linkCrearEquipo) {
                // Quitamos la clase disabled y el pointer-events
                linkCrearEquipo.classList.remove('link-disabled');
                linkCrearEquipo.style.pointerEvents = 'auto'; 
                // Actualizamos el href dinámicamente
                linkCrearEquipo.href = `{% url 'crear_equipo' %}?cliente_id=${clienteId}&next=crear_orden`;
            }
        }

        function desactivarEnlaceEquipo() {
            if (linkCrearEquipo) {
                linkCrearEquipo.classList.add('link-disabled');
                linkCrearEquipo.style.pointerEvents = 'none'; // Bloqueo real a nivel CSS
                linkCrearEquipo.removeAttribute('href'); // Seguridad extra
            }
        }
        
        // Listener extra por si alguien fuerza el clic (aunque pointer-events lo evita)
        linkCrearEquipo.addEventListener('click', function(e) {
            if (linkCrearEquipo.classList.contains('link-disabled')) {
                e.preventDefault();
                alert("Por favor, selecciona un cliente antes de registrar un equipo.");
            }
        });

        // --- 3. BÚSQUEDA ---
        
        // Habilitar búsqueda con ENTER
        searchInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                btnBuscar.click(); 
            }
        });

        btnBuscar.addEventListener('click', function() {
            const query = searchInput.value;
            if (query.length < 3) {
                alert("Ingresa al menos 3 caracteres para buscar.");
                return;
            }

            fetch(`{% url 'buscar_cliente_api' %}?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    resultsContainer.innerHTML = ''; 
                    resultsContainer.style.display = 'block';

                    if (data.resultados.length === 0) {
                        resultsContainer.innerHTML = '<div class="result-item" style="color: #777;">No se encontraron clientes.</div>';
                    } else {
                        data.resultados.forEach(cliente => {
                            const div = document.createElement('div');
                            div.classList.add('result-item');
                            div.innerHTML = `<strong>${cliente.nombre}</strong> - ${cliente.telefono}`;
                            
                            div.addEventListener('click', function() {
                                seleccionarCliente(cliente);
                            });
                            resultsContainer.appendChild(div);
                        });
                    }
                });
        });

        function seleccionarCliente(cliente) {
            // Llenar datos del cliente
            clientHiddenInput.value = cliente.id;
            displayNombre.textContent = cliente.nombre;
            displayTel.textContent = cliente.telefono;
            
            // UI Update
            card.style.display = 'block';
            searchInput.disabled = true;
            resultsContainer.style.display = 'none';

            // Llenar el select de equipos
            equipoSelect.innerHTML = '<option value="">-- Seleccionar Equipo --</option>';
            if (cliente.equipos.length > 0) {
                cliente.equipos.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq.id;
                    option.textContent = `${eq.tipo_equipo} ${eq.marca} ${eq.modelo} (S/N: ${eq.numero_serie || 'S/N'})`;
                    equipoSelect.appendChild(option);
                });
            } else {
                equipoSelect.innerHTML = '<option value="">-- Este cliente no tiene equipos registrados --</option>';
            }

            // ACTIVAR ENLACE (Lógica corregida)
            activarEnlaceEquipo(cliente.id);
        }

        // Botón "Cambiar" cliente
        btnCambiar.addEventListener('click', function() {
            clientHiddenInput.value = '';
            card.style.display = 'none';
            searchInput.disabled = false;
            searchInput.value = '';
            searchInput.focus();
            
            // Resetear Equipos
            equipoSelect.innerHTML = '<option value="">-- Primero selecciona un cliente --</option>';
            
            // DESACTIVAR ENLACE
            desactivarEnlaceEquipo();
        });
    });
</script>
{% endblock %}