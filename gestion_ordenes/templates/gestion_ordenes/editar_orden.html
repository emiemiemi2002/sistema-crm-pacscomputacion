{% extends 'base.html' %}

{% block title %}Finalizar Orden #{{ orden.id }} - CRM PACS{% endblock %}

{% block extra_css %}
<style>
    .page-header { margin-bottom: 2rem; }
    .page-title { font-size: 2rem; font-weight: 700; color: var(--color-primario); }

    .order-form { background: var(--color-fondo-card); border: 1px solid var(--color-borde); border-radius: 12px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
    
    .form-section { margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 1px dashed var(--color-borde); }
    .form-section h2 { font-size: 1.25rem; font-weight: 600; color: var(--color-primario); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
    
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem 2rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
    
    /* Estilos para Info Estática (Readonly) */
    .static-info { background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e9ecef; }
    .static-info strong { color: #333; display: block; font-size: 1rem; }
    .static-info small { color: #666; display: block; margin-top: 0.25rem; font-size: 0.85rem; }
    
    label { font-size: 0.9rem; font-weight: 600; color: var(--color-texto-secundario); }
    
    /* Input Select destacado para el Cierre */
    .closure-select { 
        width: 100%; padding: 1rem; border-radius: 8px; 
        border: 2px solid var(--color-primario); background: #fff; 
        font-size: 1.1rem; font-weight: 600; color: var(--color-primario);
    }

    .form-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
    
    /* Alerta visual de Cierre */
    .closure-alert {
        background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;
        padding: 1rem; border-radius: 8px; margin-bottom: 2rem;
        display: flex; align-items: center; gap: 10px;
    }
</style>
{% endblock %}

{% block content %}

    <div class="page-header">
        <h1 class="page-title">Finalizar y Cerrar Orden #{{ orden.id }}</h1>
    </div>

    <div class="closure-alert">
        <i class="fas fa-info-circle" style="font-size: 1.5rem;"></i>
        <div>
            <strong>Atención:</strong> Estás a punto de cerrar esta orden. 
            Al confirmar, se registrará la fecha de cierre y no se podrán realizar más cambios.
        </div>
    </div>

    <form method="POST" class="order-form">
        {% csrf_token %}
        
        <!-- SECCIÓN 1: CLIENTE (Solo Lectura) -->
        <section class="form-section">
            <h2>
                <svg style="width:24px;height:24px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> 
                Cliente
            </h2>
            <div class="static-info">
                <strong>{{ orden.cliente.nombre_completo }}</strong>
                <small>Tel: {{ orden.cliente.telefono }} | RFC: {{ orden.cliente.rfc|default:"--" }}</small>
            </div>
        </section>

        <!-- SECCIÓN 2: EQUIPO (Solo Lectura) -->
        <section class="form-section">
            <h2>
                <svg style="width:24px;height:24px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> 
                Equipo
            </h2>
            <div class="static-info">
                <strong>{{ orden.equipo.tipo_equipo }} {{ orden.equipo.marca }} {{ orden.equipo.modelo }}</strong>
                <small>Serie: {{ orden.equipo.numero_serie|default:"S/N" }}</small>
            </div>
        </section>

        <!-- SECCIÓN 3: DETALLES DEL SERVICIO (Solo Lectura para Contexto) -->
        <section class="form-section">
            <h2>
                <svg style="width:24px;height:24px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg> 
                Resumen del Servicio
            </h2>
            
            <div class="form-group">
                <label>Falla Reportada</label>
                <div class="static-info" style="background: white;">{{ orden.descripcion_falla }}</div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Estado Actual</label>
                    <div class="static-info">
                        <strong>{{ orden.estado }}</strong>
                    </div>
                </div>

                <div class="form-group">
                    <label>Contraseña Equipo</label>
                    <div class="static-info">{{ orden.contrasena_equipo|default:"--" }}</div>
                </div>
                
                <div class="form-group">
                    <label>Prioridad</label>
                    <div class="static-info">{{ orden.prioridad }}</div>
                </div>
                
                <div class="form-group">
                    <label>Técnico Responsable</label>
                    <div class="static-info">
                        {% if orden.tecnico_asignado %}
                            {{ orden.tecnico_asignado.first_name }} {{ orden.tecnico_asignado.last_name }}
                        {% else %}
                            <span style="color:#d32f2f;">Sin asignar</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN 4: ACCIÓN DE CIERRE (Editable) -->
        <section class="form-section" style="border-bottom: none; background-color: #fcfcfc; padding: 20px; border-radius: 8px;">
            <h2 style="color: #2e7d32; margin-bottom: 1rem;">
                <i class="fas fa-check-circle" style="margin-right: 10px;"></i> Acción de Cierre
            </h2>
            
            <div class="form-group">
                <label for="estado" style="font-size: 1rem;">Seleccione el Estado Final para Cerrar la Orden:</label>
                <select name="estado" id="estado" class="closure-select">
                    <!-- Iteramos sobre 'estados_cierre' que envía la vista filtrada -->
                    {% for codigo, nombre in estados_cierre %}
                        <option value="{{ codigo }}">{{ nombre }}</option>
                    {% empty %}
                        <option value="">No hay acciones de cierre disponibles para el estado actual.</option>
                    {% endfor %}
                </select>
                <small style="color: #666; margin-top: 5px;">
                    * Si la orden está "Finalizada por Técnico", solo podrás entregarla. Si no, solo podrás cancelarla.
                </small>
            </div>
        </section>

        <div class="form-actions">
            <a href="{% url 'lista_ordenes' %}" class="btn btn-secondary" style="text-decoration: none; background:#fff; border:1px solid #ccc; color:#333; padding: 0.8rem 1.5rem; border-radius: 6px;">Cancelar</a>
            
            {% if estados_cierre %}
            <button type="submit" class="btn btn-primary" style="padding: 0.8rem 1.5rem; font-size: 1rem;">
                Confirmar Cierre
            </button>
            {% endif %}
        </div>
    </form>

{% endblock %}