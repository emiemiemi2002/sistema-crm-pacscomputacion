{% extends 'base.html' %}

{% block title %}Administrar Orden #{{ orden.id }} - CRM PACS{% endblock %}

{% block extra_css %}
<style>
    /* Cabecera */
    .page-header { 
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; 
        border-bottom: 1px solid var(--color-borde); padding-bottom: 1rem;
    }
    .page-title { font-size: 2rem; font-weight: 700; color: var(--color-primario); margin: 0; }
    
    .status-pill {
        display: inline-block; padding: 0.4rem 1rem; border-radius: 20px;
        background: #f0f4f8; color: var(--color-primario); font-weight: 600; font-size: 0.9rem;
        margin-left: 1rem; vertical-align: middle;
    }

    /* Grid Layout */
    .admin-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; }
    @media (max-width: 992px) { .admin-grid { grid-template-columns: 1fr; } }

    /* Tarjetas */
    .admin-card { 
        background: white; border: 1px solid var(--color-borde); 
        border-radius: 12px; overflow: hidden; margin-bottom: 2rem; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .card-header { 
        padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--color-borde); 
        background: #fcfcfc; font-weight: 700; color: var(--color-primario); 
        display: flex; align-items: center; gap: 10px; font-size: 1.05rem;
    }
    .card-body { padding: 1.8rem; }

    /* Inputs */
    label { font-weight: 600; font-size: 0.9rem; color: var(--color-texto-secundario); display: block; margin-bottom: 0.5rem; }
    input, select { 
        width: 100%; padding: 0.75rem; border-radius: 8px; 
        border: 1px solid var(--color-borde); background-color: #fff; 
        font-family: inherit; font-size: 0.95rem; transition: border-color 0.2s;
    }
    input:focus, select:focus { border-color: var(--color-primario); outline: none; box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1); }
    
    .form-group { margin-bottom: 1.5rem; }

    /* Bloqueo Visual */
    .locked-input { 
        background-color: #f1f3f5; color: #6c757d; border-color: #e9ecef; cursor: not-allowed; 
        padding: 0.75rem; border-radius: 8px; font-size: 0.95rem;
    }
    .lock-icon { float: right; font-size: 0.9rem; color: #adb5bd; margin-top: 3px; }

    /* Botones */
    .btn-update { 
        width: 100%; background: var(--color-primario); color: white; 
        padding: 0.9rem; border: none; border-radius: 8px; cursor: pointer; 
        font-weight: 600; font-size: 1rem; transition: background 0.2s;
    }
    .btn-update:hover { background: #34495e; }

    .btn-close-order { 
        width: 100%; background: #2e7d32; color: white; padding: 1rem; 
        border: none; border-radius: 8px; cursor: pointer; 
        font-weight: 700; font-size: 1.1rem; margin-top: 10px; 
        box-shadow: 0 4px 6px rgba(46, 125, 50, 0.2);
    }
    .btn-close-order:hover { background-color: #1b5e20; }
    
    .btn-close-order.cancel { background: #c62828; box-shadow: 0 4px 6px rgba(198, 40, 40, 0.2); }
    .btn-close-order.cancel:hover { background-color: #b71c1c; }

    /* Sección de Cierre */
    .closure-select { font-size: 1.1rem; border: 2px solid var(--color-primario); padding: 0.8rem; }
</style>
{% endblock %}

{% block content %}

    <div class="page-header">
        <div>
            <h1 class="page-title">
                Administrar Orden #{{ orden.id }}
                <span class="status-pill">{{ orden.estado }}</span>
            </h1>
        </div>
        <a href="{% url 'lista_ordenes' %}" class="btn btn-secondary" style="text-decoration:none; border:1px solid #ccc; color:#333; padding: 0.6rem 1.2rem; border-radius: 6px;">
            &larr; Volver a la Lista
        </a>
    </div>

    <!-- Mensajes Globales -->
    {% if messages %}
        <div style="margin-bottom: 2rem;">
        {% for message in messages %}
            <div style="padding: 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
                {% if message.tags == 'error' %}background:#ffebee; color:#c62828; border:1px solid #ef9a9a;
                {% else %}background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9;{% endif %}">
                <span>{{ message }}</span>
                <button onclick="this.parentElement.style.display='none'" style="background:none; border:none; cursor:pointer; color:inherit; font-weight:bold;">&times;</button>
            </div>
        {% endfor %}
        </div>
    {% endif %}

    <div class="admin-grid">
        
        <!-- COLUMNA 1: Edición de Detalles -->
        <div class="column-left">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="accion" value="guardar_detalles">

                <div class="admin-card">
                    <div class="card-header">
                        <i class="fas fa-sliders-h"></i> Detalles Operativos
                    </div>
                    <div class="card-body">
                        <!-- Técnico -->
                        <div class="form-group">
                            <label for="tecnico">Técnico Responsable</label>
                            {% if puede_editar_tecnico %}
                                <select name="tecnico_asignado" id="tecnico">
                                    <option value="">-- Sin asignar --</option>
                                    {% for tecnico in tecnicos_list %}
                                        <option value="{{ tecnico.id }}" {% if orden.tecnico_asignado.id == tecnico.id %}selected{% endif %}>
                                            {{ tecnico.first_name }} {{ tecnico.last_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            {% else %}
                                <div class="locked-input">
                                    {{ orden.tecnico_asignado.get_full_name|default:"Sin asignar" }}
                                    <i class="fas fa-lock lock-icon" title="Bloqueado: Orden Finalizada"></i>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Prioridad -->
                        <div class="form-group">
                            <label for="prioridad">Prioridad</label>
                            {% if puede_editar_prioridad %}
                                <select name="prioridad" id="prioridad">
                                    {% for codigo, nombre in prioridades %}
                                        <option value="{{ codigo }}" {% if orden.prioridad == codigo %}selected{% endif %}>{{ nombre }}</option>
                                    {% endfor %}
                                </select>
                            {% else %}
                                <div class="locked-input">
                                    {{ orden.prioridad }}
                                    <i class="fas fa-lock lock-icon"></i>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Contraseña (Siempre abierta) -->
                        <div class="form-group">
                            <label for="contrasena">Contraseña / PIN del Equipo</label>
                            <input type="text" name="contrasena_equipo" id="contrasena" value="{{ orden.contrasena_equipo|default:'' }}">
                        </div>

                        <button type="submit" class="btn-update">Guardar Cambios</button>
                    </div>
                </div>
            </form>

            <!-- Info Estática -->
            <div class="admin-card">
                <div class="card-header" style="background:#fff; border-bottom:none; color:#666;">
                    <i class="fas fa-info-circle"></i> Resumen Fijo
                </div>
                <div class="card-body" style="background-color: #f9f9f9; padding-top:0;">
                    <div style="margin-bottom:10px;"><strong>Cliente:</strong> {{ orden.cliente.nombre_completo }}</div>
                    <div style="margin-bottom:10px;"><strong>Equipo:</strong> {{ orden.equipo.tipo_equipo }} {{ orden.equipo.modelo }}</div>
                    <div><strong>Falla:</strong> {{ orden.descripcion_falla }}</div>
                </div>
            </div>
        </div>

        <!-- COLUMNA 2: Cierre de Orden -->
        <div class="column-right">
            <form method="POST" onsubmit="return confirm('¿Estás seguro? Esta acción cerrará la orden permanentemente y no se podrá deshacer.');">
                {% csrf_token %}
                <input type="hidden" name="accion" value="cerrar_orden">

                <div class="admin-card" style="border-color: {% if es_finalizada %}#2e7d32{% else %}#c62828{% endif %};">
                    <div class="card-header" style="background-color: {% if es_finalizada %}#e8f5e9{% else %}#ffebee{% endif %}; color: {% if es_finalizada %}#1b5e20{% else %}#b71c1c{% endif %};">
                        <i class="fas fa-check-double"></i> Finalización
                    </div>
                    <div class="card-body">
                        <label for="estado_cierre" style="font-size:1rem; margin-bottom:10px;">Acción disponible:</label>
                        <select name="estado_cierre" id="estado_cierre" class="closure-select">
                            {% for codigo, nombre in estados_cierre %}
                                <option value="{{ codigo }}">{{ nombre }}</option>
                            {% empty %}
                                <option value="">No hay acciones disponibles</option>
                            {% endfor %}
                        </select>

                        <div style="margin-top: 1.5rem; font-size: 0.9rem; line-height: 1.5; color: #555;">
                            {% if es_finalizada %}
                                <p><i class="fas fa-check-circle" style="color:green;"></i> El técnico ha reportado el trabajo como <strong>Finalizado</strong>.</p>
                                <p>Seleccione "Entregada" una vez que el cliente haya recogido el equipo.</p>
                                <button type="submit" class="btn-close-order">Confirmar Entrega</button>
                            {% else %}
                                <p><i class="fas fa-exclamation-triangle" style="color:#c62828;"></i> El trabajo <strong>NO ha sido finalizado</strong>.</p>
                                <p>Solo puedes <strong>Cancelar</strong> la orden si el cliente desistió del servicio.</p>
                                <button type="submit" class="btn-close-order cancel">Confirmar Cancelación</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>

    </div>

{% endblock %}