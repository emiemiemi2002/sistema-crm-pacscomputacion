{% extends 'base.html' %}

{% block title %}Registrar Equipo - CRM PACS{% endblock %}

{% block extra_css %}
<style>
    .page-header { margin-bottom: 2rem; }
    .page-title { font-size: 2rem; font-weight: 700; color: var(--color-primario); }
    
    .form-card { 
        background: var(--color-fondo-card); 
        border: 1px solid var(--color-borde); 
        border-radius: 12px; 
        padding: 2.5rem; 
        max-width: 800px; 
        margin: 0 auto; /* Centrado */
        box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .form-group { margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
    label { font-weight: 600; font-size: 0.9rem; color: var(--color-texto-secundario); }
    
    input, select {
        padding: 0.85rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--color-borde);
        background-color: var(--color-input-bg);
        font-family: 'Inter', sans-serif;
        font-size: 0.95rem;
    }
    input:focus, select:focus { outline: none; border-color: var(--color-primario); }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    
    .form-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--color-borde); padding-top: 1.5rem; }
    
    .client-readonly {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        color: #0d47a1;
        font-weight: 600;
        cursor: not-allowed;
    }

    /* ESTILO NUEVO: Grupo de Password */
    .password-wrapper { position: relative; }
    .password-wrapper input { padding-right: 40px; } /* Espacio para el icono */
    .toggle-password {
        position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
        background: none; border: none; cursor: pointer; color: #999;
    }
    .toggle-password:hover { color: var(--color-primario); }
</style>
{% endblock %}

{% block content %}

    <div class="page-header" style="text-align: center;">
        <h1 class="page-title">Registrar Nuevo Equipo</h1>
    </div>

    <div class="form-card">
        <form method="POST">
            {% csrf_token %}
            
            <!-- Selección de Cliente -->
            <div class="form-group">
                <label for="cliente_select">Cliente Propietario *</label>
                {% if cliente_pre %}
                    <!-- Caso 1: Cliente ya seleccionado (viene de otra vista) -->
                    <input type="text" class="client-readonly" value="{{ cliente_pre.nombre_completo }}" readonly>
                    <input type="hidden" name="cliente_id" value="{{ cliente_pre.id }}">
                {% else %}
                    <!-- Caso 2: Selección manual -->
                    <select name="cliente_id" id="cliente_select" required>
                        <option value="">-- Selecciona un Cliente --</option>
                        {% for c in clientes_list %}
                            <option value="{{ c.id }}">{{ c.nombre_completo }}</option>
                        {% endfor %}
                    </select>
                    <small style="margin-top: 0.25rem;">
                        ¿No encuentras al cliente? <a href="{% url 'lista_clientes' %}" style="color: var(--color-primario);">Créalo primero aquí</a>.
                    </small>
                {% endif %}
            </div>

            <!-- Detalles del Equipo -->
            <div class="form-row">
                <div class="form-group">
                    <label for="tipo_equipo">Tipo de Equipo *</label>
                    <select name="tipo_equipo" id="tipo_equipo" required>
                        <option value="">-- Selecciona Tipo --</option>
                        {% for codigo, nombre in tipos_equipo %}
                            <option value="{{ codigo }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="marca">Marca *</label>
                    <input type="text" name="marca" id="marca" placeholder="Ej. Dell, HP, Apple" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="modelo">Modelo *</label>
                    <input type="text" name="modelo" id="modelo" placeholder="Ej. Inspiron 15, MacBook Air" required>
                </div>
                <div class="form-group">
                    <label for="serie">Número de Serie</label>
                    <input type="text" name="serie" id="serie" placeholder="S/N (Opcional pero recomendado)">
                </div>
            </div>

            <!-- MEJORA: Campo de Contraseña -->
            <div class="form-group">
                <label for="contrasena">Contraseña del Equipo / PIN (Opcional)</label>
                <div class="password-wrapper">
                    <input type="password" name="contrasena_equipo" id="contrasena" placeholder="Patrón de desbloqueo, PIN o contraseña de usuario" autocomplete="new-password">
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('contrasena')" title="Mostrar/Ocultar">
                        <svg style="width:20px;height:20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </button>
                </div>
                <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">Se guardará de forma segura (encriptada). Solo los técnicos podrán verla.</small>
            </div>

            <div class="form-actions">
                <a href="{% if cliente_pre %}{% url 'detalle_cliente' cliente_pre.id %}{% else %}{% url 'lista_clientes' %}{% endif %}" class="btn btn-secondary" style="text-decoration: none; border: 1px solid #ccc; color: #333;">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar Equipo</button>
            </div>
        </form>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    // MEJORA: Función para mostrar/ocultar contraseña
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
    }
</script>
{% endblock %}