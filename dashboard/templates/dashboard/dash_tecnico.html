{% extends 'base.html' %}

{% block title %}Mi Cola de Trabajo - PACS CRM{% endblock %}

{% block extra_css %}
<style>
    /* --- ENCABEZADO Y SALUDO --- */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--color-borde);
    }

    .header-info h1 {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--color-primario);
        margin: 0;
        line-height: 1.1;
    }

    .welcome-msg {
        font-size: 1.1rem;
        color: var(--color-texto-secundario);
        margin-top: 0.8rem;
    }

    /* --- TARJETAS DE KPI (Estilo Recepción) --- */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--color-borde);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        display: flex;
        align-items: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .kpi-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.05);
    }

    .kpi-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1.25rem;
        flex-shrink: 0;
    }

    /* Colores de Iconos */
    .icon-critical { background-color: #fee2e2; color: #dc2626; } /* Rojo */
    .icon-pending  { background-color: #e0f2fe; color: #0284c7; } /* Azul */
    .icon-waiting  { background-color: #ffedd5; color: #ea580c; } /* Naranja */
    .icon-total    { background-color: #f3f4f6; color: #4b5563; } /* Gris */

    .kpi-info h3 { 
        margin: 0; 
        font-size: 2rem; 
        font-weight: 800; 
        color: var(--color-primario); 
        line-height: 1;
    }

    .kpi-info p { 
        margin: 0; 
        font-size: 0.85rem; 
        color: var(--color-texto-secundario); 
        font-weight: 700; 
        text-transform: uppercase;
        margin-top: 5px;
        letter-spacing: 0.5px;
    }

    /* --- PANEL DE TRABAJO (TABLA) --- */
    .work-panel {
        background: white;
        border: 1px solid var(--color-borde);
        border-radius: 14px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        overflow: hidden;
    }

    .work-panel-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--color-borde);
        background-color: #fcfcfc;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .work-panel-title { 
        font-size: 1.25rem; 
        font-weight: 700; 
        color: var(--color-primario); 
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .work-table { width: 100%; border-collapse: collapse; }
    .work-table th { 
        background: #f8f9fa; text-align: left; padding: 1.2rem 1.5rem; 
        font-size: 0.8rem; text-transform: uppercase; color: #666; letter-spacing: 1px;
        font-weight: 700;
        border-bottom: 2px solid var(--color-borde);
    }
    .work-table td { padding: 1.2rem 1.5rem; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
    
    .work-row { transition: background 0.2s; cursor: pointer; }
    .work-row:hover { background-color: #f8fbff; }

    /* Indicadores de Prioridad */
    .priority-indicator { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 0.95rem; }
    .dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 1px #eee; }
    .dot-alta { background-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); }
    .dot-normal { background-color: #f59e0b; }
    .dot-baja { background-color: #10b981; }

    /* Estado Badge */
    .status-badge {
        padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;
        text-transform: uppercase; background: #f1f5f9; color: #475569;
    }
    .st-diagnostico { background: #fef3c7; color: #92400e; }
    .st-reparacion { background: #dcfce7; color: #166534; }
    .st-espera { background: #f3e8ff; color: #6b21a8; }

    /* Estado Vacío */
    .empty-state { text-align: center; padding: 6rem 2rem; color: #94a3b8; }
    .empty-state i { font-size: 4rem; margin-bottom: 1.5rem; color: #e2e8f0; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- 1. ENCABEZADO -->
    <header class="dashboard-header">
        <div class="header-info">
            <h1>
                {% if saludo|add:"0" < 12 %}
                    <i class="fas fa-sun" style="color: #f59e0b; margin-right: 12px;"></i>Buenos días
                {% elif saludo|add:"0" < 19 %}
                    <i class="fas fa-cloud-sun" style="color: #fb923c; margin-right: 12px;"></i>Buenas tardes
                {% else %}
                    <i class="fas fa-moon" style="color: #6366f1; margin-right: 12px;"></i>Buenas noches
                {% endif %}, 
                {{ user.first_name|default:user.username }}
            </h1>
            <p class="welcome-msg">Resumen operativo: Tienes <strong>{{ stats.total }}</strong> órdenes asignadas.</p>
        </div>
        <div class="header-date" style="text-align: right; color: var(--color-texto-secundario); font-weight: 600;">
            <i class="far fa-calendar-check" style="margin-right: 5px;"></i> {{ today|date:"l, d F Y" }}
        </div>
    </header>

    <!-- 2. SECCIÓN DE KPIs (Idéntica a Recepción en estructura) -->
    <section class="kpi-grid">
        <!-- Prioridad Crítica -->
        <div class="kpi-card">
            <div class="kpi-icon icon-critical">
                <i class="fas fa-fire-alt"></i>
            </div>
            <div class="kpi-info">
                <h3>{{ stats.criticas }}</h3>
                <p>Urgencias</p>
            </div>
        </div>

        <!-- Por Iniciar -->
        <div class="kpi-card">
            <div class="kpi-icon icon-pending">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="kpi-info">
                <h3>{{ stats.por_diagnosticar }}</h3>
                <p>Por Iniciar</p>
            </div>
        </div>

        <!-- Esperando Refacción -->
        <div class="kpi-card">
            <div class="kpi-icon icon-waiting">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="kpi-info">
                <h3>{{ stats.detenidas }}</h3>
                <p>Sin Refacción</p>
            </div>
        </div>

        <!-- Total -->
        <div class="kpi-card">
            <div class="kpi-icon icon-total">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="kpi-info">
                <h3>{{ stats.total }}</h3>
                <p>Total en Cola</p>
            </div>
        </div>
    </section>

    <!-- 3. TABLA DE TRABAJO -->
    <div class="work-panel">
        <div class="work-panel-header">
            <h2 class="work-panel-title">
                <i class="fas fa-tasks" style="color: var(--color-primario); font-size: 1.1rem;"></i>
                Cola de Trabajo Personal
            </h2>
            <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; background: #f1f5f9; padding: 4px 12px; border-radius: 20px;">
                <i class="fas fa-sort-amount-down-alt" style="margin-right: 5px;"></i> Orden Priorizado
            </div>
        </div>

        {% if mis_ordenes %}
        <div style="overflow-x: auto;">
            <table class="work-table">
                <thead>
                    <tr>
                        <th>Prioridad</th>
                        <th>Folio</th>
                        <th>Cliente</th>
                        <th>Equipo / Modelo</th>
                        <th>Estado Actual</th>
                        <th>Fecha Ingreso</th>
                    </tr>
                </thead>
                <tbody>
                    {% for orden in mis_ordenes %}
                    <tr class="work-row" onclick="window.location='{% url 'detalle_orden' orden.id %}'">
                        <td>
                            <div class="priority-indicator">
                                <span class="dot dot-{{ orden.prioridad|lower }}"></span>
                                {{ orden.prioridad }}
                            </div>
                        </td>
                        <td><strong style="color: var(--color-primario);">#{{ orden.id }}</strong></td>
                        <td style="font-weight: 600;">{{ orden.cliente.nombre_completo|truncatechars:30 }}</td>
                        <td>
                            <div style="font-weight: 700; color: #1e293b; font-size: 0.95rem;">{{ orden.equipo.tipo_equipo }}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">{{ orden.equipo.marca }} {{ orden.equipo.modelo }}</div>
                        </td>
                        <td>
                            <span class="status-badge 
                                {% if orden.estado == 'En diagnóstico' %}st-diagnostico
                                {% elif orden.estado == 'En reparación' %}st-reparacion
                                {% elif 'Esperando' in orden.estado %}st-espera{% endif %}">
                                {{ orden.estado }}
                            </span>
                        </td>
                        <td>
                            <div style="font-size: 0.9rem; font-weight: 600; color: #334155;">{{ orden.fecha_creacion|date:"d/m/Y" }}</div>
                            <div style="font-size: 0.75rem; color: #94a3b8; font-weight: 500;">Hace {{ orden.fecha_creacion|timesince }}</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-mug-hot"></i>
            <h3>¡Bandeja de entrada vacía!</h3>
            <p>No tienes órdenes de servicio asignadas en este momento.</p>
        </div>
        {% endif %}
    </div>

</div>

<!-- Aseguramos la carga de Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}